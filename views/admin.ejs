<%- include('partials/header.ejs') %>
  <style>
    body {
      background: #181c24;
      margin: 0;
      padding: 0;
      color: #eaf6ff;
      font-family: 'Roboto', Arial, sans-serif;
      overflow-x: hidden;
    }


    .admin-dashboard-wrapper {
      display: flex;
      min-height: 90vh;
      width: 100vw;
    }

    .admin-sidebar {
      width: 240px;
      background: #23283a;
      color: #eaf6ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 0;
      box-shadow: 2px 0 12px #0002;
    }

    .admin-logo {
      font-family: "Shadows Into Light", cursive;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 36px;
      letter-spacing: 2px;
      color: #51ff00;
    }

    .admin-nav {
      display: flex;
      flex-direction: column;
      gap: 18px;
      width: 100%;
      align-items: center;
    }

    .admin-nav-link {
      color: #eaf6ff;
      text-decoration: none;
      font-size: 1.08rem;
      font-weight: 500;
      padding: 10px 32px;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
      width: 80%;
      text-align: center;
    }

    .admin-nav-link.active {
      background: #b7e4c7;
      color: #23283a;
    }

    .admin-main-content {
      flex: 1;
      background: #181c24;
      padding: 48px 40px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-height: 90vh;
    }

    .admin-content-header h1 {
      font-size: 2rem;
      color: #b7e4c7;
      margin-bottom: 12px;
    }

    .admin-content-header p {
      font-size: 1.1rem;
      color: #eaf6ff;
      margin-bottom: 24px;
    }

    .create-blog-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 18px;
      width: 100%;
      max-width: 500px;
    }

    .blog-input {
      font-size: 1.1rem;
      padding: 20px;
      border-radius: 6px;
      border: 1px solid #b7e4c7;
      background: #23283a;
      color: #eaf6ff;
      outline: none;
    }



    .blog-btn {
      background: #b7e4c7;
      color: #23283a;
      font-size: 1.08rem;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .blog-btn:hover {
      background: #23283a;
      color: #b7e4c7;
      border: 1px solid #b7e4c7;
    }

    .generate_button {
      background-color: #597b49;

      color: white;
      position: relative;
      cursor: pointer;
      border: none;
      margin-left: 300px;


    }

    .blog-description {
      border: 3px #eaf6ff solid;
      min-width: 400px;
      max-width: 420px;
      min-height: 450px;
      margin: 30px 0px;
      padding: 0px;


    }

    .loader {
      border: 6px solid #eaf6ff;
      border-top: 6px solid #51ff00;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    #titles {
      border-radius: 20px;

      width: fit-content;

    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 900px) {
      .admin-dashboard-wrapper {
        flex-direction: column;
      }

      .admin-sidebar {
        width: 100vw;
        flex-direction: row;
        justify-content: center;
        padding: 18px 0;
        box-shadow: none;
      }

      .admin-nav {
        flex-direction: row;
        gap: 12px;
        width: auto;
      }

      .admin-nav-link {
        width: auto;
        padding: 8px 18px;
      }

      .admin-main-content {
        padding: 24px 10vw;
      }
    }

    option {
      background-color: #181c24;
    }
  </style>


  <div class="admin-dashboard-wrapper">
    <aside class="admin-sidebar">
      <div class="admin-logo">Your <span style="color: red;">MethLab</span></div>
      <nav class="admin-nav">
        <a href="/admin/create" class="admin-nav-link<%= (activeTab === 'create') ? ' active' : '' %>">Create Blog</a>
        <a href="/admin" class="admin-nav-link<%= (activeTab === 'dashboard') ? ' active' : '' %>">Dashboard</a>
      </nav>
    </aside>
    <main class="admin-main-content">
      <% if (activeTab==='dashboard' ) { %>
        <div class="admin-content-header">
          <h1>Welcome, Admin!</h1>
          <% if (messages.success.length>0) { %>
            <div class="alert alert-success" style="background: rgb(132, 121, 59); display: block; margin: 50px;">
              <%= messages.success %>
            </div>
            <% } %>
              <% if (messages.error.length>0) { %>
                <div class="alert alert-danger " style="background: rgb(132, 121, 59); display: block; margin: 50px;">
                  <%= messages.error %>
                </div>
                <% } %>

          <div class="menu">
            <% user_blogs.forEach(element=> { %>

              <div class="title-div">
                <div id="titles" style="height: 100px;">


                  <h5 class="card-title"
                    style="padding: 20px; margin: 0; background-color: rgb(94, 129, 161); border-radius:15px ; display: inline-block;">
                    <span><img src="./Assets/QuickBlog-Assets/blog_icon.png" /></span>
                    <%=element.title %>
                  </h5>

                  <a href="/admin/<%=element.id%>/delete" onclick="return confirm('Are you sure you want to delete this post?');">
                    <span style="width: 100px; margin: 10px; cursor: pointer;"><img src="/Assets/QuickBlog-Assets/delete.svg"
                        style="width: 50px;" /></span>
                  </a>
                 





                </div>
              </div>

              <% }) %>


          </div>


        </div>

        <% } else if (activeTab==='create' ) { %>
          <% if (messages.success.length>0) { %>
            <div class="alert alert-success" style="background: rgb(132, 121, 59); display: block; ">
              <%= messages.success %>
            </div>
            <% } %>
              <% if (messages.error.length>0) { %>
                <div class="alert alert-danger " style="background: rgb(132, 121, 59); display: block;">
                  <%= messages.error %>
                </div>
                <% } %>
                  <div class="admin-content-header">
                    <h1>Create a New Blog</h1>
                    <form class="create-blog-form" id="blog-form" action="/admin/create" method="POST"
                      enctype="multipart/form-data">
                      <p>Upload thumbnail</p>

                      <img id="upload_area" style="width: 150px; cursor: pointer;"
                        src="/Assets/QuickBlog-Assets/upload_area.svg" alt="" />
                      <input type="file" id="fileInput" name="image" accept="image/*" hidden required />




                  </div>

                  <input type="text" name="title" placeholder="Blog Title" required class="blog-input"
                    style="margin:20px 0px;" />
                  <input type="text" name="name" placeholder="Enter your Name" required class="blog-input"
                    style="margin:20px 0px;" maxlength="25" />
                  <label for="category">Choose a category:</label>
                  <select name="category" id="category" form="blog-form"
                    style="padding: 15px; width: 250px; background-color: #2f60c01f; color:wheat; border: 1px solid white; margin-top: 5px;">
                    <option value="Technology" selected>Technology</option>
                    <option value="Startup">Startup</option>
                    <option value="Lifestyle">Lifestyle</option>
                    <option value="Finance">Finance</option>
                    <option value="Story">Story</option>
                  </select>

                  <br><br>
                  <textarea name="description" style="display: none;"></textarea>
                  <div class="blog-description">
                    <div id="editor" style="min-width: 350px; height: 450px; border: none ; ">



                    </div>
                    <button class="generate_button" id="generateBtn"
                      style="margin-bottom: 5px; margin-right: 5px;">Generate with AI</button>
                  </div>
                  <button type="submit" class="blog-btn">Create Blog</button>

                  </form>


                  

  </div>
  <% } %>
    </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>



    <script>

      //quill initialization
      const quill = new Quill('#editor', {
        theme: 'snow'
      });



      // generate_with_AI button script
      document.querySelector('.generate_button').addEventListener('click', async function (e) {
        e.preventDefault();
        const generateBtn = document.querySelector('.generate_button');
        const descDiv = document.querySelector('.blog-description');
        const quillEditor = document.querySelector('#editor');

        const topic = document.querySelector('input[name="title"]').value;
        if (!topic) {
          quill.innerHTML = "<h1>Type a Title for the blog</h1>";
          return;
        }
        if (generateBtn.disabled) return;
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';
        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic })
          });
          const data = await response.json();
          let html = data.generatedText;
          // const html = marked.parse(text);
          console.log('HTML to paste:', html);
          // quillEditor.removeChild(quillEditor.firstChild);
          // quill.setContents([{ insert: 'Test Quill content\n' }]);
          quill.root.innerHTML = html;

        } catch (err) {
          descDiv.innerHTML = `<div style='color:red;'>Error generating blog post. Please try again.</div>`;
        }
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate with AI';
      });






      //upload_area manipulation
      document.querySelector('#upload_area').onclick = function () {
        document.getElementById('fileInput').click();
      };
      document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {

            const img = document.getElementById('upload_area');

            img.src = e.target.result;

          };
          reader.readAsDataURL(file);
        }
      });

      document.querySelector('.create-blog-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const submitBtn = document.querySelector('.blog-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        const html = quill.root.innerHTML;
        document.querySelector('textarea[name="description"]').value = html;

        if (!html || html === '<p><br></p>') {
          alert('Blog content cannot be empty.');
          submitBtn.disabled = false;
          submitBtn.textContent = "Create Blog";
          return;
        }

        e.target.submit();
      });





    </script>
    <%- include('partials/footer.ejs') %>